
<!--<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Speech Translate (Hidden Input)</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            background: #1a2732;
            color: white;
            font-family: sans-serif;
            height: 120vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-bottom: 140px;
        }

        .controls {
            display: flex;
            gap: 10px;
            padding: 10px;
            justify-content: center;
            background: #111;
            border-top: 1px solid #333;
        }

        .section {
            padding: 10px 30px;
            display: flex;
            flex-direction: column;
        }

            .section h3 {
                font-size: 24px;
                margin-bottom: 10px;
            }

        .text-block {
            height: 90vh;
            font-size: 10vh;
            text-align: center;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid #444;
            padding: 20px;
            box-sizing: border-box;
        }

        #translatedText {
            color: #e0e0e0;
            font-style: italic;
        }

        button {
            padding: 8px 16px;
            font-size: 16px;
            cursor: pointer;
        }

        #originalSection {
            display: none;
        }

        #log {
            background: #000;
            color: lime;
            font-size: 14px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .settings-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            bottom: 24px;
        }

        .settings-toggle {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #333;
            color: white;
            font-size: 24px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px #000;
            transition: background 0.3s;
        }

            .settings-toggle:hover {
                background: #444;
            }

        .controls {
            position: absolute;
            right: 70px;
            bottom: 0;
            background: #111;
            padding: 6px 10px;
            border-radius: 20px; /* Mềm hơn khung */
            border: 1px solid #444;
            display: flex;
            flex-direction: row;
            gap: 8px;
            opacity: 0;
            transform: translateX(20px);
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

            .controls.show {
                opacity: 1;
                transform: translateX(0);
                pointer-events: all;
            }

            .controls button {
                background: #222;
                color: white;
                border: none;
                padding: 6px 18px; /* 📏 nhỏ lại nhưng dài hơn */
                font-size: 14px;
                cursor: pointer;
                border-radius: 999px;
                transition: background 0.2s, transform 0.2s;
                min-height: auto;
                min-width: auto;
                white-space: nowrap;
            }

                .controls button:hover {
                    background: #444;
                    transform: scale(1.05);
                }

        .settings-toggle {
            box-shadow: 0 4px 16px rgba(0,0,0,0.5);
        }

        .controls button.active {
            background: #2a3b4a; /* xanh sáng hoặc bạn đổi màu khác cũng được */
            color: #fff;
            font-weight: bold;
            box-shadow: 0 0 6px rgba(74, 144, 226, 0.8);
        }

        .controls button.active {
            background: #2a3b4a;
            color: #fff;
            font-weight: bold;
            box-shadow: 0 0 6px rgba(74, 144, 226, 0.8);
        }
        .controls select {
            background: #222;
            color: white;
            border: none;
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 999px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            transition: background 0.2s;
            height: auto;
        }

            .controls select:hover {
                background: #444;
            }

            .controls select:focus {
                outline: none;
                box-shadow: 0 0 6px rgba(74, 144, 226, 0.8);
            }
        .controls input[type="number"] {
            background: #222;
            color: white;
            border: none;
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 999px;
            width: 80px;
            text-align: center;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            transition: background 0.2s;
            box-shadow: none;
        }

            .controls input[type="number"]:focus {
                outline: none;
                box-shadow: 0 0 6px rgba(74, 144, 226, 0.8);
            }

            .controls input[type="number"]::-webkit-outer-spin-button,
            .controls input[type="number"]::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
        .font-input {
            background: #222;
            color: white;
            border: none;
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 999px;
            text-align: center;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            transition: background 0.2s;
            box-shadow: none;
        }

            .font-input:focus {
                outline: none;
                box-shadow: 0 0 6px rgba(74, 144, 226, 0.8);
            }

    </style>
</head>
<body>
    <div class="content">
        <div class="section" id="originalSection">
            <h3>🗣️ Bạn nói:</h3>
            <div id="originalText" class="text-block"></div>
        </div>

        <div class="section">
            <div id="translatedText" class="text-block"></div>
        </div>
    </div>

    <h2 id="status" style="text-align: center;">🎤 Đang khởi động...</h2>

    <div class="settings-container">
        <button class="settings-toggle" onclick="toggleSettings()">⚙️</button>
        <div class="controls" id="controlsMenu">
            <button onclick="setLanguage('vi-VN')">🇻🇳 VN</button>
            <button onclick="setLanguage('en-US')">🇺🇸 US</button>
            <button onclick="setTranslator('azure')">Azure</button>
            <button onclick="setTranslator('google')">Google</button>
            <button onclick="retry()">🔁 Thử lại</button>

            <div id="fontControlContainer">
                <select id="fontSelect" onchange="handleFontSelectChange(this.value)">
                    <option value="">Cỡ chữ</option>
                    <option value="8">8</option>
                    <option value="10" selected>10</option>
                    <option value="12">12</option>
                    <option value="14">14</option>
                    <option value="16">16</option>
                    <option value="custom">Tuỳ chỉnh</option>
                </select>

            </div>
            <select id="zoomSelect" onchange="setZoom(this.value)">
                <option value="0.5">50%</option>
                <option value="0.75">75%</option>
                <option value="1" selected>100%</option>
                <option value="1.25">125%</option>
                <option value="1.5">150%</option>
            </select>



        </div>
    </div>
    <div id="log"></div>
    <script>
        let recognition;
        let currentLang = 'vi-VN';
        let isTranslating = false;
        let speechBuffer = "";
        let lastProcessTime = Date.now();
        let translationTimeout = null;
        let lastSpeechTime = Date.now();
        let lastBufferContent = "";
        let isRetrying = false;
        let currentTranslator = 'azure'; // mặc định
        let controller = null;

        let AZURE_SUBSCRIPTION_KEY = '';
        let AZURE_REGION = '';
        let AZURE_ENDPOINT = '';

        function applyConfigFromWPF() {
            if (window.ENV) {
                AZURE_SUBSCRIPTION_KEY = window.ENV.AZURE_SUBSCRIPTION_KEY || '';
                AZURE_REGION = window.ENV.AZURE_REGION || '';
                AZURE_ENDPOINT = window.ENV.AZURE_ENDPOINT || '';
                console.log("✅ Key nhận từ WPF:", AZURE_SUBSCRIPTION_KEY);
            } else {
                console.warn("❌ Không có ENV từ WPF.");
            }
        }
        function detectAndStart() {
            if (recognition) recognition.stop();

            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = currentLang;
            recognition.continuous = true;
            recognition.interimResults = false;

            recognition.onresult = function (event) {
                lastSpeechTime = Date.now();

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    const transcript = result[0].transcript.trim();
                    if (transcript.length > 0) {
                        speechBuffer += transcript + " ";
                    }
                }
            };

            recognition.onend = function () { };

            recognition.onerror = function (event) {
                document.getElementById("status").textContent = "⚠️ Lỗi mic: " + event.error;
            };

            recognition.start();
            updateStatus();
        }

        function updateStatus() {
            const lang = currentLang === 'vi-VN' ? 'Tiếng Việt' : 'English';
            const time = new Date().toLocaleTimeString();
            document.getElementById("status").textContent = `🎤 (${time}) Đang nghe bằng ${lang}...`;
        }

        function retry() {
            if (isRetrying) return;
            isRetrying = true;
            setTimeout(() => isRetrying = false, 3000);

            speechBuffer = "";
            recognition?.stop();
            document.getElementById("translatedText").textContent = "";
            detectAndStart();
        }

        async function translateViaAzure(text) {
            const controller = new AbortController();
            const timeout = setTimeout(() => {
                controller.abort();
            }, 5000);

            try {
                const sourceLang = currentLang.startsWith('vi') ? 'vi' : 'en';
                const targetLang = sourceLang === 'vi' ? 'en' : 'vi';
                const url = `${AZURE_ENDPOINT}/translate?api-version=3.0&from=${sourceLang}&to=${targetLang}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Ocp-Apim-Subscription-Key': AZURE_SUBSCRIPTION_KEY,
                        'Ocp-Apim-Subscription-Region': AZURE_REGION,
                        'Content-type': 'application/json'
                    },
                    body: JSON.stringify([{ Text: text }]),
                    signal: controller.signal
                });

                const data = await response.json();
                return data[0]?.translations[0]?.text || '';
            } catch (err) {
                return '';
            } finally {
                clearTimeout(timeout);
            }
        }

        async function translateViaGoogle(text) {
            const sourceLang = currentLang.startsWith('vi') ? 'vi' : 'en';
            const targetLang = sourceLang === 'vi' ? 'en' : 'vi';

            if (controller) controller.abort();
            controller = new AbortController();

            try {
                const res = await fetch(
                    `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`,
                    { signal: controller.signal }
                );
                const data = await res.json();
                return data[0].map(item => item[0]).join('');
            } catch (err) {
                return '';
            }
        }

        function setTranslator(type) {
            currentTranslator = type;

            const buttons = document.querySelectorAll("#controlsMenu button");
            buttons.forEach(btn => btn.classList.remove("active"));

            if (currentLang === 'vi-VN') {
                buttons[0].classList.add("active");
            } else if (currentLang === 'en-US') {
                buttons[1].classList.add("active");
            }

            if (type === 'azure') {
                buttons[2].classList.add("active");
            } else if (type === 'google') {
                buttons[3].classList.add("active");
            }
        }

        async function translateNow(text) {
            isTranslating = true;

            clearTimeout(translationTimeout);
            translationTimeout = setTimeout(() => {
                isTranslating = false;
            }, 8000);

            try {
                let translated = '';

                if (currentTranslator === 'azure') {
                    translated = await translateViaAzure(text);
                } else if (currentTranslator === 'google') {
                    translated = await translateViaGoogle(text);
                }

                const box = document.getElementById("translatedText");
                box.textContent += translated + ' ';

                if (box.textContent.length > 4000) {
                    box.textContent = box.textContent.slice(-4000);
                }
                box.scrollTop = box.scrollHeight;
            } catch (err) {
                console.error("⚠️ Lỗi khi dịch:", err);
            } finally {
                clearTimeout(translationTimeout);
                isTranslating = false;
            }
        }

        window.onload = () => {
            detectAndStart();

            const savedFontSize = localStorage.getItem("fontSize");
            if (savedFontSize) {
                applyFontSize(savedFontSize);
                document.getElementById("fontSelect").value = savedFontSize;
            }

            const savedZoom = localStorage.getItem('zoomScale') || '1';
            setZoom(savedZoom);
            document.getElementById('zoomSelect').value = savedZoom;




            setInterval(() => {
                if (!isTranslating && speechBuffer.trim().length > 0) {
                    const now = Date.now();
                    let words = speechBuffer.trim().split(/\s+/);

                    if ((words.length >= 8 && now - lastProcessTime > 1000)) {
                        const chunk = words.slice(0, 8).join(" ");
                        speechBuffer = words.slice(8).join(" ");
                        translateNow(chunk);
                        lastProcessTime = now;
                    } else if (words.length > 0 && now - lastProcessTime > 2000) {
                        const chunk = words.join(" ");
                        speechBuffer = "";
                        translateNow(chunk);
                        lastProcessTime = now;
                    }

                    if (speechBuffer === lastBufferContent && Date.now() - lastSpeechTime > 12000) {
                        retry();
                    } else {
                        lastBufferContent = speechBuffer;
                    }
                }

                if (Date.now() - lastSpeechTime > 30000) {
                    retry();
                }
            }, 300);
        };

        function toggleSettings() {
            const menu = document.getElementById("controlsMenu");
            menu.classList.toggle("show");
        }

        function setLanguage(langCode) {
            currentLang = langCode;
            retry();

            const buttons = document.querySelectorAll("#controlsMenu button");
            buttons.forEach(btn => btn.classList.remove("active"));

            if (langCode === 'vi-VN') {
                buttons[0].classList.add("active");
            } else if (langCode === 'en-US') {
                buttons[1].classList.add("active");
            }
        }

        function applyFontSize(size) {
            const fontSize = parseInt(size);
            if (!isNaN(fontSize) && fontSize >= 4 && fontSize <= 24) {
                document.querySelectorAll('.text-block').forEach(el => {
                    el.style.fontSize = fontSize + 'vh';
                });
                localStorage.setItem("fontSize", fontSize);
            }
        }

        function handleFontSelectChange(value) {
            if (value === "custom") {
                const container = document.getElementById("fontControlContainer");

                container.innerHTML = `
            <input type="number" id="customFontInput"
                   placeholder="vh"
                   min="4" max="24"
                   style="width: 70px;"
                   class="font-input"
                   onblur="resetToSelect()"
                   oninput="applyCustomFontSize(this.value)">
        `;
                document.getElementById("customFontInput").focus();
            } else {
                applyFontSize(value);
            }
        }

        function applyCustomFontSize(value) {
            applyFontSize(value);
        }

        function resetToSelect() {
            const savedFont = localStorage.getItem("fontSize") || 10;
            document.getElementById("fontControlContainer").innerHTML = `
        <select id="fontSelect" onchange="handleFontSelectChange(this.value)">
            <option value="">Cỡ chữ</option>
            <option value="8">8</option>
            <option value="10">10</option>
            <option value="12">12</option>
            <option value="14">14</option>
            <option value="16">16</option>
            <option value="custom">Tuỳ chỉnh</option>
        </select>
    `;
            document.getElementById("fontSelect").value = savedFont;
        }


        function setZoom(scale) {
            const content = document.querySelector('.content');
            content.style.transform = `scale(${scale})`;
            content.style.transformOrigin = 'top center';

            localStorage.setItem('zoomScale', scale);
        }



    </script>

</body>
</html>-->

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Azure Speech AI Realtime Translate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        html, body {
            margin: 0;
            padding: 0;
            background-color: transparent !important;
            color: white;
            font-family: sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        /* GIỮ LẠI - Background overlay có opacity thay đổi */
        #backgroundMainOverlay {
            position: fixed;
            inset: 0;
            z-index: 0;
            background: rgba(26, 39, 50, 1);
            pointer-events: none;
            transition: background 0.2s;
        }

        /* GIỮ LẠI - Khung ngôn ngữ hiển thị theo vị trí nút bấm */
        .lang-bar {
            position: fixed;
            background: #1a2732;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            gap: 10px;
            z-index: 99999 !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

            .lang-bar button {
                background: #222;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 999px;
                cursor: pointer;
                font-size: 14px;
            }

                .lang-bar button.active,
                .lang-bar button:hover {
                    background: #2a3b4a;
                    font-weight: bold;
                    box-shadow: 0 0 6px rgba(74, 144, 226, 0.8);
                }
        #langBar {
            position: fixed;
            background: #1a2732;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            gap: 10px;
            z-index: 999999 !important; /* tăng z-index lên cao hơn cả khối text */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }


        /* GIỮ LẠI - text-block để in văn bản lớn đẹp hơn */
        .text-block {
            max-height: 80vh;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 6vh;
        }



        #translatedText {
            color: #e0e0e0;
            font-style: normal;
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 6vh;
            line-height: 1.4;
            transition: all 0.2s ease-in-out;
        }

        /* GIỮ LẠI - Slider custom không có sẵn trong Bootstrap */
        .opacity-control {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        #opacitySlider {
            width: 100px;
        }

        /* Giữ để xử lý .hidden toggle */
        .hidden {
            display: none !important;
        }
        #controlsMenu {
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease-in-out;
        }

            #controlsMenu.show {
                opacity: 1;
                visibility: visible;
                transform: translateY(0);
            }
        .custom-controls-menu {
            position: fixed;
            bottom: 20px;
            right: 80px;
            z-index: 999;
            background: #223343;
            border: 1px solid #2a3b4a;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease-in-out;
        }

            .custom-controls-menu.show {
                opacity: 1;
                visibility: visible;
                transform: translateY(0);
            }
        .original-bg {
            background: rgba(34, 51, 67, 0.6); /* hơi xanh tím than mờ */
            border: 1px solid #2a3b4a;
            border-radius: 12px;
        }

        .translated-bg {
            background: transparent !important;
            border: none !important;
        }
        .partial-text {
            color: #888;
            font-style: italic;
            font-size: 5vh;
            margin-top: 8px;
            text-align: center;
            white-space: pre-wrap;
        }
        .scroll-container {
            max-height: 100vh;
            overflow-y: auto;
            padding: 20px;
        }


        #translatedText div {
            margin-bottom: 20px;
            font-size: 6vh;
        }

        #partialText div {
            font-size: 5vh;
        }
        .partial-line {
            font-style: italic;
            color: #888;
        }
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* tránh scroll tràn */
        }
        #loadingOverlay.fade-out {
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }

        .opacity-control {
            align-items: center;
            gap: 6px;
        }

        .floating-opacity-control {
            position: fixed;
            background-color: rgba(0, 0, 0, 0.75);
            padding: 8px 12px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 9999;
            color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        #colorPickerContainer {
            position: absolute;
            bottom: 100%;
            left: 0;
            margin-bottom: 8px;
            z-index: 999999;
            padding: 10px 12px;
            border-radius: 12px;
            background: linear-gradient(145deg, #1e293b, #334155); /* nền gradient than xanh */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5); /* đổ bóng mềm */
            border: 1px solid rgba(255, 255, 255, 0.1); /* viền nhẹ */
            display: none;
        }




    </style>
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
</head>
<body>

    <div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center bg-dark bg-opacity-75" style="z-index: 9999;">
        <div class="spinner-border text-info" style="width: 4rem; height: 4rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-3 text-white fs-5">Đang khởi động...</div>
    </div>


    <div id="backgroundMainOverlay"></div>

    <div class="content">


        <div id="translationContainer" class="scroll-container">
            <div id="translatedText" class="text-block"></div>
            <div id="partialText" class="text-block"></div>

        </div>
    </div>
    <div class="position-fixed bottom-0 end-0 p-3">
        <!-- Thay nút cũ -->
        <!-- Nút setting -->



        <button onclick="toggleSettings()"
                style="position: fixed; bottom: 20px; right: 20px; width: 48px; height: 48px; border-radius: 50%; background: #333; color: white; z-index: 1000;">
            ⚙️
        </button>

        <!-- KHUNG CONTROL -->
        <div id="controlsMenu"
             class="p-3 d-flex flex-wrap gap-2 rounded-pill shadow-lg custom-controls-menu">


            <!-- ... các nút bên trong như cũ ... -->
            <button id="toggleBtn" class="btn btn-dark" onclick="toggleRecording()">🔊 Bắt đầu</button>
            <button class="btn btn-outline-light" onclick="toggleLangBar('source', this)">🗣 Ngôn ngữ Nói</button>
            <button class="btn btn-outline-light" onclick="toggleLangBar('target', this)">🌐 Dịch</button>
            <button class="btn btn-outline-warning" onclick="retry()">🔁 Thử lại</button>


            <!-- Nút mở bảng màu -->
            <div class="color-picker-wrapper" style="position: relative; display: inline-block;">
                <button class="btn btn-outline-light" onclick="toggleColorPicker()">🎨 Màu nền</button>

                <div id="colorPickerContainer"
                     style="display: none; position: absolute; bottom: 100%; left: 0; margin-bottom: 8px; z-index: 999999; background: rgba(0,0,0,0.85); padding: 8px; border-radius: 8px;"
                     class="text-white">
                    <input type="color" id="bgColorPicker" onchange="applyBackgroundColor(this.value)">
                </div>
            </div>




            <select class="form-select form-select-sm w-auto" id="fontSelect" onchange="handleFontSelectChange(this.value)">
                <option value="">Cỡ chữ</option>
                <option value="8">8</option>
                <option value="10" selected>10</option>
                <option value="12">12</option>
                <option value="14">14</option>
                <option value="16">16</option>
                <option value="custom">Tuỳ chỉnh</option>
            </select>

            <!-- Ô nhập số: ban đầu ẩn -->
            <input type="number" id="fontInput"
                   placeholder="vh"
                   min="4" max="24"
                   style="width: 70px; margin-left: 8px; display: none;"
                   oninput="applyCustomFontSize(this.value)">


            <select class="form-select form-select-sm w-auto" id="zoomSelect" onchange="setZoom(this.value)">
                <option value="0.5">50%</option>
                <option value="0.75">75%</option>
                <option value="1" selected>100%</option>
                <option value="1.25">125%</option>
                <option value="1.5">150%</option>
            </select>

            <button id="opacityBtn" class="btn btn-outline-secondary" onclick="toggleOpacityControl()">🌫️ Độ mờ nền</button>


            <button class="btn btn-outline-primary" onclick="toggleTopmost()">📌Ghim</button>
            <button class="btn btn-outline-info" onclick="toggleFullscreen()">⛶</button>
            <button class="btn btn-danger" onclick="exitApp()">❌ Thoát</button>


        </div>

    </div>
    <div id="floatingOpacity"
         style="display: none; position: fixed; z-index: 9999; background: rgba(0,0,0,0.8); padding: 8px; border-radius: 8px;"
         class="text-white">
        <input type="range" id="backgroundAlphaSlider" min="0" max="1" step="0.05" value="1"
               oninput="updateBackgroundOpacity(this.value)">
        <span id="backgroundAlphaValue">100%</span>
    </div>

    <div id="langBar" class="lang-bar hidden"></div>
    <script>

        let sourceLang = 'vi-VN';
        let targetLang = 'en';
        let recognizer = null;
        let latestFinalSentences = [];
        let AZURE_SUBSCRIPTION_KEY = "";
        let AZURE_REGION = "";
        let isRecording = false;
        let lineIndex = 0;

        window.addEventListener("DOMContentLoaded", () => {
            const loading = document.getElementById("loadingOverlay");

            // 1. Hiện loading ngay (nếu chưa hiện)
            if (loading) loading.style.display = "flex";

            setTimeout(() => {
                // Ẩn loading (mượt hơn nếu dùng fade-out như đã nói)
                if (loading) {
                    loading.classList.add("fade-out");
                    setTimeout(() => {
                        loading.style.display = "none";
                    }, 500);
                }

                // 3. Các xử lý chính vẫn chạy song song
                highlightActiveLang();

                waitForAzureConfig((key, region) => {
                    AZURE_SUBSCRIPTION_KEY = key;
                    AZURE_REGION = region;
                    startRecognizer();
                });

                const bgOpacity = localStorage.getItem('bgOpacity') || "1";
                const mainBgOpacity = localStorage.getItem('mainBgOpacity') || "1";
                const zoomScale = localStorage.getItem('zoomScale') || "1";
                const savedFontSize = localStorage.getItem("fontSize");

                if (savedFontSize) {
                    applyFontSize(savedFontSize);

                    const select = document.getElementById("fontSelect");
                    const input = document.getElementById("fontInput");

                    const predefined = ["8", "10", "12", "14", "16"];
                    if (predefined.includes(savedFontSize)) {
                        select.value = savedFontSize;
                        if (input) input.style.display = "none";
                    } else {
                        select.value = "custom";
                        if (input) {
                            input.style.display = "inline-block";
                            input.value = savedFontSize;
                        }
                    }
                }

                setZoom(zoomScale);

                const slider = document.getElementById('opacitySlider');
                const sliderLabel = document.getElementById('opacityValue');
                const bgColor = localStorage.getItem("backgroundColor") || "#1a2732";

                if (slider) slider.value = bgOpacity;
                if (sliderLabel) sliderLabel.textContent = Math.round(bgOpacity * 100) + "%";
                const content = document.querySelector('.content');
                if (content) content.style.opacity = bgOpacity;
                if (bgOverlay) bgOverlay.style.background = hexToRgba(bgColor, mainBgOpacity);
            }, 3000); // <-- Mọi thứ bắt đầu sau 3 giây
        });

        function startRecognizer() {
            const btn = document.getElementById("toggleBtn");
            btn.textContent = "⏹️ Ngưng";
            btn.classList.add("active");
            isRecording = true;

            logToFile("🎙️ Bắt đầu nhận giọng nói");

            if (!window.SpeechSDK) return;

            if (recognizer) {
                recognizer.stopContinuousRecognitionAsync(() => {
                    recognizer.close();
                    recognizer = null;
                    initRecognizer();
                }, err => {
                    console.error("❌ Lỗi khi stop:", err);
                    recognizer = null;
                    initRecognizer();
                });
            } else {
                initRecognizer();
            }
        }

        function toggleRecording() {
            const btn = document.getElementById("toggleBtn");

            if (isRecording) {
                stopRecognizer();
                btn.textContent = "🔊 Bắt đầu";
                btn.classList.remove("active");
                isRecording = false;
            } else {
                startRecognizer();
                btn.textContent = "⏹️ Ngưng";
                btn.classList.add("active");
                isRecording = true;
            }
        }

        function stopRecognizer() {
            const btn = document.getElementById("toggleBtn");
            btn.textContent = "🔊 Bắt đầu";
            btn.classList.remove("active");
            isRecording = false;

            logToFile("🛑 Đã dừng nhận giọng nói");

            if (recognizer) {
                recognizer.stopContinuousRecognitionAsync(() => {
                    recognizer.close();
                    recognizer = null;
                    console.log("🛑 Đã ngưng");
                }, err => {
                    console.error("❌ Lỗi khi dừng:", err);
                    recognizer = null;
                });
            }
        }

        function waitForAzureConfig(callback) {
            const maxTry = 100; // giới hạn tránh lặp vô hạn
            let tryCount = 0;

            const interval = setInterval(() => {
                const env = window.ENV;
                if (env?.AZURE_SUBSCRIPTION_KEY && env?.AZURE_REGION) {
                    clearInterval(interval);
                    callback(env.AZURE_SUBSCRIPTION_KEY, env.AZURE_REGION);
                }

                if (++tryCount > maxTry) {
                    clearInterval(interval);
                    console.error("❌ Không thể load ENV từ WPF");
                }
            }, 100);
        }

        function initRecognizer() {
            const sdk = window.SpeechSDK;
            const config = sdk.SpeechTranslationConfig.fromSubscription(AZURE_SUBSCRIPTION_KEY, AZURE_REGION);
            config.speechRecognitionLanguage = sourceLang;
            config.addTargetLanguage(targetLang);

            const audioConfig = sdk.AudioConfig.fromDefaultMicrophoneInput();
            recognizer = new sdk.TranslationRecognizer(config, audioConfig);

            recognizer.recognizing = (s, e) => {
                const partial = e.result.translations.get(targetLang);
                if (partial) {
                    const el = document.getElementById("translatedText");

                    // Nếu đã có phần đoán trước → xóa
                    const lastPartial = el.querySelector(".partial-line");
                    if (lastPartial) el.removeChild(lastPartial);

                    // ⭐ Lấy fontSize hiện tại
                    const fontSize = parseInt(localStorage.getItem("fontSize") || 10);

                    // Thêm mới phần đoán realtime
                    const span = document.createElement("div");
                    span.className = "partial-line";
                    span.style.color = "#888888";
                    span.style.fontStyle = "italic";
                    span.style.textAlign = "center";
                    span.style.fontSize = (fontSize - 2) + "vh"; // ⭐ Áp dụng font size
                    span.textContent = partial;
                    el.appendChild(span);

                    // Scroll xuống
                    el.scrollTo({ top: el.scrollHeight, behavior: 'smooth' });
                }
            };


            recognizer.recognized = (s, e) => {
                if (e.result.reason === sdk.ResultReason.TranslatedSpeech) {
                    const final = e.result.translations.get(targetLang);
                    if (!final) return;

                    const el = document.getElementById("translatedText");

                    logToFile(`✅ Kết quả dịch: ${final}`);
                    // Xóa bản đoán cũ
                    const lastPartial = el.querySelector(".partial-line");
                    if (lastPartial) el.removeChild(lastPartial);

                    const div = document.createElement("div");
                    const fontSize = parseInt(localStorage.getItem("fontSize") || 10); // ⭐ Lấy font size đã lưu
                    div.style.textAlign = "center";
                    div.style.color = lineIndex % 2 === 0 ? "#ffffff" : "#00ffd5";
                    div.style.marginBottom = "16px";
                    div.style.fontSize = fontSize + "vh"; // ⭐ Gán font size
                    div.textContent = final;
                    el.appendChild(div);

               

                    lineIndex++;

                    el.scrollTo({ top: el.scrollHeight, behavior: 'smooth' });
                }
            };

            recognizer.canceled = (s, e) => {
                console.error('[canceled]', e);

                // Ghi log ra file
                logToFile(`❌ Canceled: ${e.errorDetails || 'Không rõ nguyên nhân'}`);

                // Tự động retry
                retry();
            };

            recognizer.sessionStopped = () => console.log('🛑 Session stopped.');

            recognizer.startContinuousRecognitionAsync(
                () => console.log('🚀 Đang nghe...'),
                err => console.error('❌ Lỗi khởi động:', err)
            );
        }

        function retry() {
            const loading = document.getElementById("loadingOverlay");
            const bgOverlay = document.getElementById("backgroundMainOverlay");

            // 🔁 Khôi phục màu nền mặc định
            const defaultColor = "#1a2732";
            const defaultOpacity = localStorage.getItem('mainBgOpacity') || "1";
            if (bgOverlay) {
                bgOverlay.style.background = hexToRgba(defaultColor, defaultOpacity);
            }

            if (!loading) {
                startRecognizer();
                return;
            }

            // ✅ GỠ fade-out nếu có
            loading.classList.remove("fade-out");

            // ✅ Hiện overlay lại
            loading.style.display = "flex";

            logToFile("🔁 Đang retry nhận giọng nói");

            // ✅ Bắt đầu vòng chờ
            requestAnimationFrame(() => {
                setTimeout(() => {
                    // ✅ Sau 3 giây mới khởi động lại
                    startRecognizer();

                    // ✅ Thêm lại fade-out nếu muốn hiệu ứng ẩn mượt
                    loading.classList.add("fade-out");
                    setTimeout(() => {
                        loading.style.display = "none";
                    }, 500);
                }, 1000);
            });
        }

        function renderSentences(partial = "") {
            const el = document.getElementById("translatedText");
            el.innerHTML = "";

            latestFinalSentences.forEach((sentence, index) => {
                const color = index % 2 === 0 ? "#ffffff" : "#00ffd5";
                el.innerHTML += `<div style="color: ${color}">${sentence}</div>`;
            });

            if (partial) {
                el.innerHTML += `<div style="color: #888888; font-style: italic;">${partial}</div>`;
            }

            el.scrollTop = el.scrollHeight;
        }

        function splitIntoSentences(text) {
            const matches = text.match(/[^.?!]+[.?!]/g);
            return matches ? matches.map(s => s.trim()) : [text.trim()];
        }

        function toggleSettings() {
            const menu = document.getElementById("controlsMenu");
            menu.classList.toggle("show");
        }

        function setSourceLanguage(lang) {
            sourceLang = lang;
            retry();
            highlightActiveLang();
            logToFile(`🗣️ Đổi ngôn ngữ nói: ${lang}`);

        }

        function setTargetLanguage(lang) {
            targetLang = lang;
            retry();
            highlightActiveLang();
            logToFile(`🌐 Đổi ngôn ngữ dịch: ${lang}`);

        }

        function highlightActiveLang() {
            const buttons = document.querySelectorAll("#controlsMenu button");
            buttons.forEach(btn => btn.classList.remove("active"));

            buttons.forEach(btn => {
                const onclickText = btn.getAttribute("onclick");
                if (onclickText?.includes(`setSourceLanguage('${sourceLang}')`) ||
                    onclickText?.includes(`setTargetLanguage('${targetLang}')`)) {
                    btn.classList.add("active");
                }
            });
        }

        function applyFontSize(size) {
            const fontSize = parseInt(size);
            if (!isNaN(fontSize) && fontSize >= 4 && fontSize <= 24) {
                const allTranslatedLines = document.querySelectorAll('#translatedText > div, .partial-line');

                allTranslatedLines.forEach(el => {
                    el.style.fontSize = fontSize + 'vh';
                });

                const input = document.getElementById("fontInput");
                if (input) input.value = fontSize;
                localStorage.setItem("fontSize", fontSize);
            }
        }

        function handleFontSelectChange(value) {
            const input = document.getElementById("fontInput");
            if (value === "custom") {
                if (input) input.style.display = "inline-block";
                input.focus();
            } else {
                if (input) input.style.display = "none";
                applyFontSize(value);
            }
        }

        function applyCustomFontSize(value) {
            applyFontSize(value);
            localStorage.setItem("fontSize", value);
        }

        function applyCustomFontSize(value) {
            applyFontSize(value);
        }

        function resetToSelect() {
            const savedFont = localStorage.getItem("fontSize") || 10;
            document.getElementById("fontControlContainer").innerHTML = `
                                    <select id="fontSelect" onchange="handleFontSelectChange(this.value)">
                                        <option value="">Cỡ chữ</option>
                                        <option value="8">8</option>
                                        <option value="10">10</option>
                                        <option value="12">12</option>
                                        <option value="14">14</option>
                                        <option value="16">16</option>
                                        <option value="custom">Tuỳ chỉnh</option>
                                    </select>
                                `;
            document.getElementById("fontSelect").value = savedFont;
        }

        function updateBackgroundOpacity(value) {
            const percent = Math.round(value * 100);
            document.getElementById("backgroundMainOverlay").style.background = `rgba(26, 39, 50, ${value})`;
            document.getElementById("backgroundAlphaValue").textContent = percent + "%";
            localStorage.setItem('mainBgOpacity', value);
        }

        window.addEventListener('load', () => {
            const saved = localStorage.getItem('bgOpacity');
            const savedFontSize = localStorage.getItem("fontSize");
            if (savedFontSize) applyFontSize(savedFontSize);

            if (saved) {
                document.querySelector('.content').style.opacity = saved;
                document.getElementById('opacitySlider').value = saved;
                document.getElementById('opacityValue').textContent = Math.round(saved * 100) + "%";
            }
        });

        function setZoom(scale) {
            const content = document.querySelector('.content');
            content.style.transform = `scale(${scale})`;
            content.style.transformOrigin = 'top center';
            localStorage.setItem('zoomScale', scale);
        }

        function toggleFullscreen() {
            if (window.chrome?.webview) {
                window.chrome.webview.postMessage({ action: "toggleFullscreen" });
            }
        }

        function toggleLangBar(type, triggerBtn) {
            const bar = document.getElementById('langBar');

            if (!bar.classList.contains('hidden')) {
                bar.classList.add('hidden');
                return;
            }

            const langs = type === 'source'
                ? [
                    { code: 'vi-VN', label: '🇻🇳 Tiếng Việt' },
                    { code: 'en-US', label: '🇺🇸 English' },
                    { code: 'zh-CN', label: '🇨🇳 中文' },
                    { code: 'ja-JP', label: '🇯🇵 日本語' }
                ]
                : [
                    { code: 'en', label: '🇺🇸 English' },
                    { code: 'vi', label: '🇻🇳 Tiếng Việt' },
                    { code: 'zh-Hans', label: '🇨🇳 中文' },
                    { code: 'ja', label: '🇯🇵 日本語' }
                ];

            const selected = type === 'source' ? sourceLang : targetLang;

            bar.innerHTML = langs.map(lang => `
                                                <button class="${lang.code === selected ? 'active' : ''}"
                                                        onclick="${type === 'source'
                    ? `setSourceLanguage('${lang.code}')`
                    : `setTargetLanguage('${lang.code}')`
                }; hideLangBar()">
                                                    ${lang.label}
                                                </button>
                                            `).join('');

            const rect = triggerBtn.getBoundingClientRect();
            const barHeight = 60; // hoặc đo động qua bar.offsetHeight sau khi hiển thị

            // ✅ Hiển thị phía trên nút để tránh bị WebView2 che
            bar.style.top = `${rect.top - barHeight}px`;
            bar.style.left = `${rect.left}px`;
            bar.classList.remove('hidden');
        }

        function toggleTopmost() {
            if (window.chrome?.webview) {
                window.chrome.webview.postMessage({ action: "toggleTopmost" });
            }
        }

        function hideLangBar() {
            document.getElementById('langBar').classList.add('hidden');
        }

        function toggleOpacityControl() {
            const floating = document.getElementById("floatingOpacity");
            const button = document.getElementById("opacityBtn");

            if (!floating || !button) return;

            const isVisible = floating.style.display === "flex";
            floating.style.display = isVisible ? "none" : "flex";

            if (!isVisible) {
                const rect = button.getBoundingClientRect();
                floating.style.left = rect.left + "px";
                floating.style.top = (rect.top - floating.offsetHeight - 10) + "px";
            }
        }   

        function toggleColorPicker() {
            const picker = document.getElementById("colorPickerContainer");
            if (!picker) return;

            const isVisible = picker.style.display === "block";
            picker.style.display = isVisible ? "none" : "block";
        }

        function applyBackgroundColor(hexColor) {
            const opacity = localStorage.getItem("mainBgOpacity") || "1";
            const rgba = hexToRgba(hexColor, opacity);
            const bg = document.getElementById("backgroundMainOverlay");
            if (bg) bg.style.background = rgba;

            localStorage.setItem("backgroundColor", hexColor);
        }

        function hexToRgba(hex, opacity) {
            const bigint = parseInt(hex.replace('#', ''), 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }

        function log(msg) {
            console.log(msg);
            const el = document.getElementById("status");
            if (el) el.textContent = msg;
        }

        function logToFile(msg) {
            if (window.chrome?.webview) {
                window.chrome.webview.postMessage({
                    action: "log",
                    data: msg
                });
            }
        }

        function exitApp() {
            if (window.chrome?.webview) {
                window.chrome.webview.postMessage({ action: "exitApp" });
            }
        }

    </script>

</body>
</html>
