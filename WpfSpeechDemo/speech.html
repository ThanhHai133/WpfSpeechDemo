<!--<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Speech Translate (Hidden Input)</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            background: #1a2732;
            color: white;
            font-family: sans-serif;
            height: 120vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-bottom: 140px;
        }

        .controls {
            display: flex;
            gap: 10px;
            padding: 10px;
            justify-content: center;
            background: #111;
            border-top: 1px solid #333;
        }

        .section {
            padding: 10px 30px;
            display: flex;
            flex-direction: column;
        }

            .section h3 {
                font-size: 24px;
                margin-bottom: 10px;
            }

        .text-block {
            height: 90vh;
            font-size: 10vh;
            text-align: center;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid #444;
            padding: 20px;
            box-sizing: border-box;
        }

        #translatedText {
            color: #e0e0e0;
            font-style: italic;
        }

        button {
            padding: 8px 16px;
            font-size: 16px;
            cursor: pointer;
        }

        #originalSection {
            display: none;
        }

        #log {
            background: #000;
            color: lime;
            font-size: 14px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .settings-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            bottom: 24px;
        }

        .settings-toggle {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #333;
            color: white;
            font-size: 24px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px #000;
            transition: background 0.3s;
        }

            .settings-toggle:hover {
                background: #444;
            }

        .controls {
            position: absolute;
            right: 70px;
            bottom: 0;
            background: #111;
            padding: 6px 10px;
            border-radius: 20px; /* Mềm hơn khung */
            border: 1px solid #444;
            display: flex;
            flex-direction: row;
            gap: 8px;
            opacity: 0;
            transform: translateX(20px);
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

            .controls.show {
                opacity: 1;
                transform: translateX(0);
                pointer-events: all;
            }

            .controls button {
                background: #222;
                color: white;
                border: none;
                padding: 6px 18px; /* 📏 nhỏ lại nhưng dài hơn */
                font-size: 14px;
                cursor: pointer;
                border-radius: 999px;
                transition: background 0.2s, transform 0.2s;
                min-height: auto;
                min-width: auto;
                white-space: nowrap;
            }

                .controls button:hover {
                    background: #444;
                    transform: scale(1.05);
                }

        .settings-toggle {
            box-shadow: 0 4px 16px rgba(0,0,0,0.5);
        }

        .controls button.active {
            background: #2a3b4a; /* xanh sáng hoặc bạn đổi màu khác cũng được */
            color: #fff;
            font-weight: bold;
            box-shadow: 0 0 6px rgba(74, 144, 226, 0.8);
        }
        .controls button.active {
            background: #2a3b4a;
            color: #fff;
            font-weight: bold;
            box-shadow: 0 0 6px rgba(74, 144, 226, 0.8);
        }

    </style>
</head>
<body>
    <div class="content">
        <div class="section" id="originalSection">
            <h3>🗣️ Bạn nói:</h3>
            <div id="originalText" class="text-block"></div>
        </div>

        <div class="section">
            <div id="translatedText" class="text-block"></div>
        </div>
    </div>

    <h2 id="status" style="text-align: center;">🎤 Đang khởi động...</h2>

    <div class="settings-container">
        <button class="settings-toggle" onclick="toggleSettings()">⚙️</button>
        <div class="controls" id="controlsMenu">
            <button onclick="setLanguage('vi-VN')">🇻🇳 VN</button>
            <button onclick="setLanguage('en-US')">🇺🇸 US</button>
            <button onclick="setTranslator('azure')">Azure</button>
            <button onclick="setTranslator('google')">Google</button>
            <button onclick="retry()">🔁 Thử lại</button>
        </div>
    </div>



    <div id="log"></div>

    <script>
        let recognition;
        let currentLang = 'vi-VN';
        let isTranslating = false;
        let speechBuffer = "";
        let lastProcessTime = Date.now();
        let translationTimeout = null;
        let lastSpeechTime = Date.now();
        let lastBufferContent = "";
        let isRetrying = false;
        let currentTranslator = 'azure'; // mặc định
        let controller = null;


        const AZURE_SUBSCRIPTION_KEY = 'adf9fb7c7ff14d758cf44b93da63fbd1';
        const AZURE_REGION = 'eastasia';
        const AZURE_ENDPOINT = 'https://api.cognitive.microsofttranslator.com';

        function log(msg) {
            const logBox = document.getElementById("log");
            const time = new Date().toLocaleTimeString();
            const line = `[${time}] ${msg}`;
            logBox.textContent += line + "\n";
            logBox.scrollTop = logBox.scrollHeight;

            // Nếu dùng WPF WebView2
            if (window.chrome?.webview?.postMessage) {
                chrome.webview.postMessage(line);
            }
        }

        function detectAndStart() {
            if (recognition) recognition.stop();

            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = currentLang;
            recognition.continuous = true;
            recognition.interimResults = false;

            recognition.onresult = function (event) {
                lastSpeechTime = Date.now(); // 🔄 Reset mỗi khi có tiếng nói

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    const transcript = result[0].transcript.trim();
                    if (transcript.length > 0) {
                        log("[🎤 Nhận được]", transcript);
                        speechBuffer += transcript + " ";
                    }
                }
            };

            recognition.onend = function () {
                log("🔕 Mic đã bị ngắt (onend)");
            };


            recognition.onerror = function (event) {
                log("⚠️ Lỗi mic: " + event.error);
                document.getElementById("status").textContent = "⚠️ Lỗi mic: " + event.error;
            };

            recognition.start();
            updateStatus();
        }

        function updateStatus() {
            const lang = currentLang === 'vi-VN' ? 'Tiếng Việt' : 'English';
            const time = new Date().toLocaleTimeString();
            document.getElementById("status").textContent = `🎤 (${time}) Đang nghe bằng ${lang}...`;
        }




        function retry() {
            if (isRetrying) return;
            isRetrying = true;
            setTimeout(() => isRetrying = false, 3000); // ⏳ Chờ 3s mới cho retry tiếp

            speechBuffer = "";
            recognition?.stop();
            document.getElementById("translatedText").textContent = "";
            log("🔁 Đang khởi động lại...");
            detectAndStart();
        }


        //function setLanguage(langCode) {
        //    currentLang = langCode;
        //    retry();
        //}

        async function translateViaAzure(text) {
            const controller = new AbortController();
            const timeout = setTimeout(() => {
                log("⏰ Timeout sau 5s với đoạn: " + text);
                controller.abort();
            }, 5000);

            try {
                const sourceLang = currentLang.startsWith('vi') ? 'vi' : 'en';
                const targetLang = sourceLang === 'vi' ? 'en' : 'vi';
                const url = `${AZURE_ENDPOINT}/translate?api-version=3.0&from=${sourceLang}&to=${targetLang}`;

                log("🌐 Đang gửi dịch: " + text);
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Ocp-Apim-Subscription-Key': AZURE_SUBSCRIPTION_KEY,
                        'Ocp-Apim-Subscription-Region': AZURE_REGION,
                        'Content-type': 'application/json'
                    },
                    body: JSON.stringify([{ Text: text }]),
                    signal: controller.signal
                });

                const data = await response.json();
                log("✅ Bản dịch về: " + (data[0]?.translations[0]?.text || '⛔ Không có kết quả'));
                return data[0]?.translations[0]?.text || '';
            } catch (err) {
                log("❌ Lỗi dịch hoặc timeout: " + err.message);
                return '';
            } finally {
                clearTimeout(timeout);
            }
        }

        async function translateViaGoogle(text) {
            const sourceLang = currentLang.startsWith('vi') ? 'vi' : 'en';
            const targetLang = sourceLang === 'vi' ? 'en' : 'vi';

            if (controller) controller.abort();
            controller = new AbortController();

            try {
                const res = await fetch(
                    `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`,
                    { signal: controller.signal }
                );
                const data = await res.json();
                return data[0].map(item => item[0]).join('');
            } catch (err) {
                if (err.name !== 'AbortError') {
                    log("❌ Google dịch lỗi: " + err.message);
                }
                return '';
            }
        }
        function setTranslator(type) {
            currentTranslator = type;

            log("🌐 Đang sử dụng: " + currentTranslator);


            const buttons = document.querySelectorAll("#controlsMenu button");
            buttons.forEach(btn => btn.classList.remove("active"));

            // Đánh dấu nút ngôn ngữ
            if (currentLang === 'vi-VN') {
                buttons[0].classList.add("active");
            } else if (currentLang === 'en-US') {
                buttons[1].classList.add("active");
            }

            // Đánh dấu dịch vụ
            if (type === 'azure') {
                buttons[2].classList.add("active");
            } else if (type === 'google') {
                buttons[3].classList.add("active");
            }
        }




        async function translateNow(text) {
            isTranslating = true;

            clearTimeout(translationTimeout);
            translationTimeout = setTimeout(() => {
                console.warn("🕒 Dịch quá lâu, auto reset isTranslating");
                isTranslating = false;
            }, 8000);

            try {
                log("[📤 Dịch đoạn]", text);
                let translated = '';

                if (currentTranslator === 'azure') {
                    translated = await translateViaAzure(text);
                } else if (currentTranslator === 'google') {
                    translated = await translateViaGoogle(text);
                }

                const box = document.getElementById("translatedText");
                box.textContent += translated + ' ';

                if (box.textContent.length > 4000) {
                    box.textContent = box.textContent.slice(-4000);
                }
                box.scrollTop = box.scrollHeight;

                log("[✅ Hiển thị bản dịch]", translated);
            } catch (err) {
                console.error("⚠️ Lỗi khi dịch:", err);
            } finally {
                clearTimeout(translationTimeout);
                isTranslating = false;
            }
        }



        window.onload = () => {
            detectAndStart();



            setInterval(() => {
                if (!isTranslating && speechBuffer.trim().length > 0) {
                    const now = Date.now();
                    let words = speechBuffer.trim().split(/\s+/);
                    log("🌀 Buffer có " + words.length + " từ");

                    if ((words.length >= 8 && now - lastProcessTime > 1000)) {
                        const chunk = words.slice(0, 8).join(" ");
                        speechBuffer = words.slice(8).join(" ");
                        log("🚀 Dịch 8 từ: " + chunk);
                        translateNow(chunk);
                        lastProcessTime = now;
                    } else if (words.length > 0 && now - lastProcessTime > 2000) {
                        const chunk = words.join(" ");
                        speechBuffer = "";
                        log("⌛ Dịch toàn bộ còn lại: " + chunk);
                        translateNow(chunk);
                        lastProcessTime = now;
                    }

                    // 👇 Kiểm tra nếu buffer không đổi trong 12 giây thì restart mic
                    if (speechBuffer === lastBufferContent && Date.now() - lastSpeechTime > 12000) {
                        log("🔁 Buffer không đổi trong 12s, restart mic...");
                        retry(); // chỉ gọi stop(), mic sẽ tự khởi động lại trong onend
                    } else {
                        lastBufferContent = speechBuffer;
                    }
                }

                if (Date.now() - lastSpeechTime > 30000) {
                    log("🛑 Không có giọng nói >30s, restart lại mic...");
                    retry();
                }
            }, 300);

        };

        function toggleSettings() {
            const menu = document.getElementById("controlsMenu");
            menu.classList.toggle("show");
        }
        function setLanguage(langCode) {
            currentLang = langCode;
            retry();

            // Đánh dấu nút nào đang được chọn
            const buttons = document.querySelectorAll("#controlsMenu button");
            buttons.forEach(btn => btn.classList.remove("active"));

            if (langCode === 'vi-VN') {
                buttons[0].classList.add("active"); // nút VN
            } else if (langCode === 'en-US') {
                buttons[1].classList.add("active"); // nút US
            }
        }


    </script>
</body>
</html>-->



<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Speech Translate (Hidden Input)</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            background: #1a2732;
            color: white;
            font-family: sans-serif;
            height: 120vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-bottom: 140px;
        }

        .controls {
            display: flex;
            gap: 10px;
            padding: 10px;
            justify-content: center;
            background: #111;
            border-top: 1px solid #333;
        }

        .section {
            padding: 10px 30px;
            display: flex;
            flex-direction: column;
        }

            .section h3 {
                font-size: 24px;
                margin-bottom: 10px;
            }

        .text-block {
            height: 90vh;
            font-size: 10vh;
            text-align: center;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid #444;
            padding: 20px;
            box-sizing: border-box;
        }

        #translatedText {
            color: #e0e0e0;
            font-style: italic;
        }

        button {
            padding: 8px 16px;
            font-size: 16px;
            cursor: pointer;
        }

        #originalSection {
            display: none;
        }

        #log {
            background: #000;
            color: lime;
            font-size: 14px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .settings-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            bottom: 24px;
        }

        .settings-toggle {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #333;
            color: white;
            font-size: 24px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px #000;
            transition: background 0.3s;
        }

            .settings-toggle:hover {
                background: #444;
            }

        .controls {
            position: absolute;
            right: 70px;
            bottom: 0;
            background: #111;
            padding: 6px 10px;
            border-radius: 20px; /* Mềm hơn khung */
            border: 1px solid #444;
            display: flex;
            flex-direction: row;
            gap: 8px;
            opacity: 0;
            transform: translateX(20px);
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

            .controls.show {
                opacity: 1;
                transform: translateX(0);
                pointer-events: all;
            }

            .controls button {
                background: #222;
                color: white;
                border: none;
                padding: 6px 18px; /* 📏 nhỏ lại nhưng dài hơn */
                font-size: 14px;
                cursor: pointer;
                border-radius: 999px;
                transition: background 0.2s, transform 0.2s;
                min-height: auto;
                min-width: auto;
                white-space: nowrap;
            }

                .controls button:hover {
                    background: #444;
                    transform: scale(1.05);
                }

        .settings-toggle {
            box-shadow: 0 4px 16px rgba(0,0,0,0.5);
        }

        .controls button.active {
            background: #2a3b4a; /* xanh sáng hoặc bạn đổi màu khác cũng được */
            color: #fff;
            font-weight: bold;
            box-shadow: 0 0 6px rgba(74, 144, 226, 0.8);
        }

        .controls button.active {
            background: #2a3b4a;
            color: #fff;
            font-weight: bold;
            box-shadow: 0 0 6px rgba(74, 144, 226, 0.8);
        }
    </style>
</head>
<body>
    <div class="content">
        <div class="section" id="originalSection">
            <h3>🗣️ Bạn nói:</h3>
            <div id="originalText" class="text-block"></div>
        </div>

        <div class="section">
            <div id="translatedText" class="text-block"></div>
        </div>
    </div>

    <h2 id="status" style="text-align: center;">🎤 Đang khởi động...</h2>

    <div class="settings-container">
        <button class="settings-toggle" onclick="toggleSettings()">⚙️</button>
        <div class="controls" id="controlsMenu">
            <button onclick="setLanguage('vi-VN')">🇻🇳 VN</button>
            <button onclick="setLanguage('en-US')">🇺🇸 US</button>
            <button onclick="setTranslator('azure')">Azure</button>
            <button onclick="setTranslator('google')">Google</button>
            <button onclick="retry()">🔁 Thử lại</button>
        </div>
    </div>
    <div id="log"></div>
    <script>
        let recognition;
        let currentLang = 'vi-VN';
        let isTranslating = false;
        let speechBuffer = "";
        let lastProcessTime = Date.now();
        let translationTimeout = null;
        let lastSpeechTime = Date.now();
        let lastBufferContent = "";
        let isRetrying = false;
        let currentTranslator = 'azure'; // mặc định
        let controller = null;

        let AZURE_SUBSCRIPTION_KEY = '';
        let AZURE_REGION = '';
        let AZURE_ENDPOINT = '';

        function applyConfigFromWPF() {
            if (window.ENV) {
                AZURE_SUBSCRIPTION_KEY = window.ENV.AZURE_SUBSCRIPTION_KEY || '';
                AZURE_REGION = window.ENV.AZURE_REGION || '';
                AZURE_ENDPOINT = window.ENV.AZURE_ENDPOINT || '';
                console.log("✅ Key nhận từ WPF:", AZURE_SUBSCRIPTION_KEY);
            } else {
                console.warn("❌ Không có ENV từ WPF.");
            }
        }
        function detectAndStart() {
            if (recognition) recognition.stop();

            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = currentLang;
            recognition.continuous = true;
            recognition.interimResults = false;

            recognition.onresult = function (event) {
                lastSpeechTime = Date.now();

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    const transcript = result[0].transcript.trim();
                    if (transcript.length > 0) {
                        speechBuffer += transcript + " ";
                    }
                }
            };

            recognition.onend = function () { };

            recognition.onerror = function (event) {
                document.getElementById("status").textContent = "⚠️ Lỗi mic: " + event.error;
            };

            recognition.start();
            updateStatus();
        }

        function updateStatus() {
            const lang = currentLang === 'vi-VN' ? 'Tiếng Việt' : 'English';
            const time = new Date().toLocaleTimeString();
            document.getElementById("status").textContent = `🎤 (${time}) Đang nghe bằng ${lang}...`;
        }

        function retry() {
            if (isRetrying) return;
            isRetrying = true;
            setTimeout(() => isRetrying = false, 3000);

            speechBuffer = "";
            recognition?.stop();
            document.getElementById("translatedText").textContent = "";
            detectAndStart();
        }

        async function translateViaAzure(text) {
            const controller = new AbortController();
            const timeout = setTimeout(() => {
                controller.abort();
            }, 5000);

            try {
                const sourceLang = currentLang.startsWith('vi') ? 'vi' : 'en';
                const targetLang = sourceLang === 'vi' ? 'en' : 'vi';
                const url = `${AZURE_ENDPOINT}/translate?api-version=3.0&from=${sourceLang}&to=${targetLang}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Ocp-Apim-Subscription-Key': AZURE_SUBSCRIPTION_KEY,
                        'Ocp-Apim-Subscription-Region': AZURE_REGION,
                        'Content-type': 'application/json'
                    },
                    body: JSON.stringify([{ Text: text }]),
                    signal: controller.signal
                });

                const data = await response.json();
                return data[0]?.translations[0]?.text || '';
            } catch (err) {
                return '';
            } finally {
                clearTimeout(timeout);
            }
        }

        async function translateViaGoogle(text) {
            const sourceLang = currentLang.startsWith('vi') ? 'vi' : 'en';
            const targetLang = sourceLang === 'vi' ? 'en' : 'vi';

            if (controller) controller.abort();
            controller = new AbortController();

            try {
                const res = await fetch(
                    `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`,
                    { signal: controller.signal }
                );
                const data = await res.json();
                return data[0].map(item => item[0]).join('');
            } catch (err) {
                return '';
            }
        }

        function setTranslator(type) {
            currentTranslator = type;

            const buttons = document.querySelectorAll("#controlsMenu button");
            buttons.forEach(btn => btn.classList.remove("active"));

            if (currentLang === 'vi-VN') {
                buttons[0].classList.add("active");
            } else if (currentLang === 'en-US') {
                buttons[1].classList.add("active");
            }

            if (type === 'azure') {
                buttons[2].classList.add("active");
            } else if (type === 'google') {
                buttons[3].classList.add("active");
            }
        }

        async function translateNow(text) {
            isTranslating = true;

            clearTimeout(translationTimeout);
            translationTimeout = setTimeout(() => {
                isTranslating = false;
            }, 8000);

            try {
                let translated = '';

                if (currentTranslator === 'azure') {
                    translated = await translateViaAzure(text);
                } else if (currentTranslator === 'google') {
                    translated = await translateViaGoogle(text);
                }

                const box = document.getElementById("translatedText");
                box.textContent += translated + ' ';

                if (box.textContent.length > 4000) {
                    box.textContent = box.textContent.slice(-4000);
                }
                box.scrollTop = box.scrollHeight;
            } catch (err) {
                console.error("⚠️ Lỗi khi dịch:", err);
            } finally {
                clearTimeout(translationTimeout);
                isTranslating = false;
            }
        }

        window.onload = () => {
            detectAndStart();

            setInterval(() => {
                if (!isTranslating && speechBuffer.trim().length > 0) {
                    const now = Date.now();
                    let words = speechBuffer.trim().split(/\s+/);

                    if ((words.length >= 8 && now - lastProcessTime > 1000)) {
                        const chunk = words.slice(0, 8).join(" ");
                        speechBuffer = words.slice(8).join(" ");
                        translateNow(chunk);
                        lastProcessTime = now;
                    } else if (words.length > 0 && now - lastProcessTime > 2000) {
                        const chunk = words.join(" ");
                        speechBuffer = "";
                        translateNow(chunk);
                        lastProcessTime = now;
                    }

                    if (speechBuffer === lastBufferContent && Date.now() - lastSpeechTime > 12000) {
                        retry();
                    } else {
                        lastBufferContent = speechBuffer;
                    }
                }

                if (Date.now() - lastSpeechTime > 30000) {
                    retry();
                }
            }, 300);
        };

        function toggleSettings() {
            const menu = document.getElementById("controlsMenu");
            menu.classList.toggle("show");
        }

        function setLanguage(langCode) {
            currentLang = langCode;
            retry();

            const buttons = document.querySelectorAll("#controlsMenu button");
            buttons.forEach(btn => btn.classList.remove("active"));

            if (langCode === 'vi-VN') {
                buttons[0].classList.add("active");
            } else if (langCode === 'en-US') {
                buttons[1].classList.add("active");
            }
        }
    </script>

</body>
</html>
